name: Template CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  test-template:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install copier pytest ruff black
      
      - name: Test template generation with default values
        run: |
          copier copy --trust --defaults . /tmp/test-project-default
          
      - name: Test template generation with custom values
        run: |
          copier copy --trust . /tmp/test-project-custom \
            --data project_name="Test Client" \
            --data project_slug="test-client" \
            --data package_name="test_client" \
            --data api_service="testapi" \
            --data include_mcp=false \
            --data include_cli=true \
            --data author_name="Test Author"
      
      - name: Verify generated project structure
        run: |
          test -f /tmp/test-project-default/pyproject.toml
          test -f /tmp/test-project-default/README.md
          test -f /tmp/test-project-default/LICENSE
          test -f /tmp/test-project-default/.github/workflows/client-ci.yml
          test -d /tmp/test-project-default/src
          test -d /tmp/test-project-default/tests
          test -d /tmp/test-project-default/docs
      
      - name: Test generated project can be installed
        run: |
          cd /tmp/test-project-default
          pip install -e .
      
      - name: Run generated project tests
        run: |
          cd /tmp/test-project-default
          pytest -v

  lint-template:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black
      
      - name: Lint Python scripts
        run: |
          ruff check scripts/
          black --check scripts/

  test-sync-script:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install copier
      
      - name: Create test project
        run: |
          copier copy --trust --defaults . /tmp/sync-test-project
      
      - name: Test sync script
        run: |
          python scripts/sync-template.py /tmp/sync-test-project --trust
