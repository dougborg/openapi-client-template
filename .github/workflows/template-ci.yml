name: Template CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  test-template:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install UV
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv pip install --system copier pytest ruff

      - name: Test template generation with default values
        run: |
          copier copy --trust --defaults . /tmp/test-project-default

      - name: Test template generation with custom values
        run: |
          copier copy --trust --defaults . /tmp/test-project-custom \
            --data project_name="Test Client" \
            --data project_slug="test-client" \
            --data package_name="test_client" \
            --data api_service="testapi" \
            --data include_mcp=false \
            --data include_cli=true \
            --data author_name="Test Author"

      - name: Verify generated project structure
        run: |
          test -f /tmp/test-project-default/my-openapi-client/pyproject.toml
          test -f /tmp/test-project-default/my-openapi-client/README.md
          test -f /tmp/test-project-default/my-openapi-client/LICENSE
          test -f /tmp/test-project-default/my-openapi-client/.github/workflows/client-ci.yml
          test -d /tmp/test-project-default/my-openapi-client/src
          test -d /tmp/test-project-default/my-openapi-client/tests
          test -d /tmp/test-project-default/my-openapi-client/docs

      - name: Install openapi-client-core locally
        run: |
          cd openapi-client-core
          uv pip install --system -e .

      - name: Test generated project can be installed
        run: |
          cd /tmp/test-project-default/my-openapi-client
          uv pip install --system -e .

      - name: Run generated project tests
        run: |
          cd /tmp/test-project-default/my-openapi-client
          uv run pytest -v

  lint-template:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install UV
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv pip install --system ruff

      - name: Lint Python scripts
        run: |
          ruff check scripts/
          ruff format --check scripts/

  test-sync-script:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install UV
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv pip install --system copier

      - name: Create test project
        run: |
          copier copy --trust --defaults . /tmp/sync-test-project

      - name: Verify copier answers file exists
        run: |
          test -f /tmp/sync-test-project/my-openapi-client/.copier-answers.yml

      - name: Test sync script
        run: |
          python scripts/sync-template.py /tmp/sync-test-project/my-openapi-client --trust
